<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸ’ ç”Ÿæ—¥å¤§å†’é™© - é©¬é‡Œå¥¥é£æ ¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Microsoft YaHei', 'Press Start 2P', Arial, sans-serif;
            background: #5c94fc;
            overflow: hidden;
            touch-action: none;
        }

        #game-canvas {
            display: block;
            margin: 0 auto;
            background: #5c94fc;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        /* UI è¦†ç›–å±‚ */
        .ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        /* é¡¶éƒ¨HUD */
        .hud {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            color: white;
            font-size: 16px;
            text-shadow: 2px 2px 0 #000;
            font-weight: bold;
        }

        .hud-item {
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 15px;
            border-radius: 8px;
            border: 2px solid white;
        }

        /* ç§»åŠ¨æ§åˆ¶æŒ‰é’® */
        .controls {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            pointer-events: auto;
        }

        .control-group {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.8);
            border: 3px solid #333;
            border-radius: 50%;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.1s;
        }

        .control-btn:active {
            transform: scale(0.9);
            background: rgba(255, 255, 255, 1);
        }

        .jump-btn {
            width: 80px;
            height: 80px;
            background: rgba(255, 107, 107, 0.9);
            color: white;
            font-size: 20px;
            font-weight: bold;
        }

        .jump-btn:active {
            background: rgba(255, 107, 107, 1);
        }
        
        /* æ–¹å‘é”®å®¹å™¨ - æ”¯æŒåŒæ—¶æŒ‰è·³è·ƒ */
        .direction-pad {
            position: relative;
            width: 140px;
            height: 140px;
        }
        
        .direction-pad .control-btn {
            position: absolute;
        }
        
        .direction-pad #btn-left {
            left: 0;
            top: 40px;
        }
        
        .direction-pad #btn-right {
            right: 0;
            top: 40px;
        }
        
        .direction-pad #btn-up {
            left: 40px;
            top: 0;
        }

        /* å¼€å§‹ç•Œé¢ */
        .start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            pointer-events: auto;
        }

        .start-screen.hidden {
            display: none;
        }

        .game-title {
            font-size: 32px;
            color: white;
            text-shadow: 4px 4px 0 #000;
            margin-bottom: 20px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .start-btn {
            padding: 20px 50px;
            font-size: 24px;
            background: white;
            border: 4px solid #333;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 6px 0 #333;
            transition: all 0.1s;
        }

        .start-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #333;
        }

        .instructions {
            margin-top: 30px;
            color: white;
            text-align: center;
            font-size: 14px;
            line-height: 1.8;
            text-shadow: 2px 2px 0 #000;
        }

        /* é—®ç­”å¼¹çª— */
        .question-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            border: 4px solid #333;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            max-width: 90%;
            display: none;
            pointer-events: auto;
        }

        .question-modal.active {
            display: block;
            animation: popIn 0.3s;
        }

        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .question-title {
            font-size: 18px;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }
        
        .question-image {
            width: 100%;
            max-width: 300px;
            max-height: 250px;
            object-fit: contain; /* ä¿æŒå›¾ç‰‡å®Œæ•´ä¸è£å‰ªä¸å˜å½¢ */
            background: white; /* ç™½è‰²èƒŒæ™¯ */
            border-radius: 10px;
            margin-bottom: 20px;
            border: 3px solid #333;
        }

        .answer-btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            font-size: 16px;
            border: 3px solid #333;
            border-radius: 10px;
            background: #f093fb;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }

        .answer-btn:hover {
            background: #f5576c;
        }

        .answer-btn.correct {
            background: #4CAF50;
        }

        .answer-btn.wrong {
            background: #f44336;
        }

        /* ç»“å±€ç•Œé¢ */
        .ending-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            pointer-events: auto;
            padding: 20px;
            overflow-y: auto;
        }

        .ending-screen.active {
            display: flex;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .ending-title {
            font-size: 36px;
            color: #f5576c;
            text-shadow: 3px 3px 0 white;
            margin-bottom: 20px;
            animation: heartBeat 1.5s infinite;
        }

        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            10%, 30% { transform: scale(1.1); }
        }

        .ending-message {
            background: white;
            padding: 30px;
            border-radius: 20px;
            border: 4px solid #333;
            max-width: 500px;
            width: 90%;
            text-align: center;
            line-height: 2;
            font-size: 16px;
            margin: 20px 0;
        }
        
        .ending-message p {
            margin: 10px 0;
        }

        .fireworks {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1; /* æ”¾åˆ°èƒŒæ™¯å±‚ï¼Œä¸é®æŒ¡è§†é¢‘ */
        }

        /* åƒç´ å­—ä½“æ ·å¼ */
        .pixel-text {
            font-family: monospace;
            letter-spacing: 2px;
        }
        
        /* æç¤ºå¼¹çª— */
        .hint-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px 40px;
            border-radius: 15px;
            border: 3px solid #FFD700;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 3000;
            max-width: 80%;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            display: none;
            pointer-events: auto;
            cursor: pointer;
        }
        
        .hint-modal.active {
            display: block;
            animation: hintPop 0.3s;
        }
        
        @keyframes hintPop {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        .hint-modal::after {
            content: '(ç‚¹å‡»å…³é—­)';
            display: block;
            margin-top: 10px;
            font-size: 12px;
            opacity: 0.7;
        }
        
        /* èƒœåˆ©ç…§ç‰‡ */
        .victory-photo {
            width: 80%;
            max-width: 400px;
            max-height: 300px;
            object-fit: contain; /* ä¿æŒå›¾ç‰‡å®Œæ•´ä¸è£å‰ª */
            background: #fff;
            border-radius: 20px;
            border: 5px solid #FFD700;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: photoZoom 0.5s;
            display: block;
        }
        
        @keyframes photoZoom {
            0% { transform: scale(0); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* èƒœåˆ©è§†é¢‘ */
        .victory-video {
            width: 90%;
            max-width: 500px;
            border-radius: 20px;
            border: 5px solid #FFD700;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: videoZoom 0.5s;
        }
        
        @keyframes videoZoom {
            0% { transform: scale(0); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- æ¸¸æˆç”»å¸ƒ -->
    <canvas id="game-canvas"></canvas>

    <!-- UI è¦†ç›–å±‚ -->
    <div class="ui-overlay">
        <!-- HUD -->
        <div class="hud">
            <div class="hud-item">ğŸ’– <span id="hearts">3</span></div>
            <div class="hud-item">â­ <span id="stars">0</span></div>
            <div class="hud-item" id="weapon-display" style="display: none;">ğŸ <span id="weapon-name"></span></div>
        </div>
        <div class="hud" style="top: 60px; justify-content: flex-start;">
            <div class="hud-item" id="fragment-display" style="display: none;">ğŸ”‘ ç¢ç‰‡: <span id="fragments">0</span>/3</div>
            <div class="hud-item">â±ï¸ <span id="timer">0</span></div>
        </div>

        <!-- ç§»åŠ¨æ§åˆ¶ -->
        <div class="controls">
            <div class="direction-pad">
                <div class="control-btn" id="btn-up">â†‘</div>
                <div class="control-btn" id="btn-left">â†</div>
                <div class="control-btn" id="btn-right">â†’</div>
            </div>
            <div class="control-group">
                <div class="control-btn jump-btn" id="btn-jump">è·³</div>
            </div>
        </div>
    </div>

    <!-- å¼€å§‹ç•Œé¢ -->
    <div class="start-screen" id="start-screen">
        <h1 class="game-title pixel-text">ğŸ® ç”Ÿæ—¥å¤§å†’é™© ğŸ‚</h1>
        <div class="instructions">
            <p>ğŸ’ å¸®åŠ©å¥³ç¥æ‰¾åˆ°ç”Ÿæ—¥ç¤¼ç‰©ï¼</p>
            <p>â­ æ”¶é›†æ˜Ÿæ˜Ÿï¼Œæ‰“è´¥æ•Œäºº</p>
            <p>â“ å›ç­”é—®é¢˜è·å¾—å¥–åŠ±</p>
            <p>ğŸ‰ å‡»è´¥å¤§BOSSè·å¾—ç¥ç¦</p>
        </div>
        <button class="start-btn" onclick="startGame()">å¼€å§‹å†’é™©</button>
    </div>

    <!-- é—®ç­”å¼¹çª— -->
    <div class="question-modal" id="question-modal">
        <img class="question-image" id="question-image" src="" alt="é—®é¢˜å›¾ç‰‡" style="display: none;">
        <div class="question-title" id="question-text"></div>
        <div id="answer-buttons"></div>
    </div>
    
    <!-- æç¤ºå¼¹çª— -->
    <div class="hint-modal" id="hint-modal" onclick="closeHint()">
        <div id="hint-text"></div>
    </div>

    <!-- ç»“å±€ç•Œé¢ -->
    <div class="ending-screen" id="ending-screen">
        <h1 class="ending-title">ğŸ‰ ç”Ÿæ—¥å¿«ä¹ ğŸ‰</h1>
        <video class="victory-video" id="victory-video" controls autoplay loop>
            <source src="loveyou.mp4" type="video/mp4">
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
        </video>
        <div class="ending-message">
            <p style="font-size: 18px; color: #f5576c; font-weight: bold;">å¥³ç¥å¤§äººï¼Œä½ æ‹¯æ•‘äº†é“¶æ²³ç³»ï¼Œ</p>
            <p style="font-size: 18px; color: #f5576c; font-weight: bold;">è·å¾—äº†æ¥è‡ªlgsloveyszæ˜Ÿçƒçš„ç”Ÿæ—¥ç¤¼ç‰©</p>
            <p style="font-size: 18px; color: #f5576c; font-weight: bold;">(Â´â–½`Êƒâ™¡Æª)</p>
            <p style="margin-top: 20px; font-size: 20px; color: #FF1493; font-weight: bold;">èµ¶ç´§å»é¢†å–å§ï¼</p>
            <p style="margin-top: 30px; color: #333;">â­ ä½ æ”¶é›†äº† <span id="final-stars">0</span> é¢—æ˜Ÿæ˜Ÿï¼</p>
        </div>
        <button class="start-btn" onclick="restartGame()">å†ç©ä¸€æ¬¡</button>
        <canvas class="fireworks" id="fireworks-canvas"></canvas>
    </div>
    
    <!-- é¢„åŠ è½½è§†é¢‘ -->
    <video id="preload-video" style="display: none;" preload="auto">
        <source src="loveyou.mp4" type="video/mp4">
    </video>

    <script>
        // ==================== æ¸¸æˆé…ç½® ====================
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');

        // è®¾ç½®ç”»å¸ƒå¤§å° - é€‚é…æ‰‹æœºç«–å±
        function resizeCanvas() {
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            
            // æ‰‹æœºç«–å±æ¨¡å¼
            if (windowWidth < windowHeight) {
                canvas.width = windowWidth;
                canvas.height = windowHeight;
            } 
            // æ¨ªå±æˆ–ç”µè„‘æ¨¡å¼
            else {
                const maxWidth = 800;
                const maxHeight = 600;
                if (windowWidth / windowHeight > maxWidth / maxHeight) {
                    canvas.height = Math.min(windowHeight, maxHeight);
                    canvas.width = canvas.height * (maxWidth / maxHeight);
                } else {
                    canvas.width = Math.min(windowWidth, maxWidth);
                    canvas.height = canvas.width * (maxHeight / maxWidth);
                }
            }
        }

        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // ==================== æ¸¸æˆçŠ¶æ€ ====================
        const game = {
            state: 'start', // start, playing, question, boss, ending
            level: 1,
            hearts: 3,
            stars: 0,
            startTime: 0,
            camera: { x: 0, y: 0 },
            gravity: 0.5,
            keys: {},
            touchControls: {
                left: false,
                right: false,
                jump: false
            }
        };

        // ==================== ç©å®¶ ====================
        const player = {
            x: 100,
            y: 100, // åˆå§‹ä½ç½®ï¼Œä¼šåœ¨loadLevelæ—¶é‡æ–°è®¾ç½®
            width: 40,
            height: 60,
            vx: 0,
            vy: 0,
            speed: 4,
            jumpForce: -15, // å¢åŠ å¼¹è·³åŠ›ï¼ˆä»-12æ”¹ä¸º-15ï¼‰
            onGround: false,
            invincible: 0,
            direction: 1, // 1=å³, -1=å·¦
            weapon: null // å½“å‰æŒæœ‰çš„æ­¦å™¨
        };

        // ==================== ç©å®¶å¤´åƒè®¾ç½® ====================
        // ğŸ¨ ä½¿ç”¨çœŸå®å¤´åƒ
        const playerAvatar = new Image();
        playerAvatar.src = 'avatar.jpg'; // ä½¿ç”¨æœ¬åœ°å¤´åƒå›¾ç‰‡
        
        // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ
        playerAvatar.onerror = function() {
            console.log('å¤´åƒåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ');
            this.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Ccircle cx="50" cy="50" r="45" fill="%23ffecd2"/%3E%3Ccircle cx="35" cy="45" r="5" fill="%23333"/%3E%3Ccircle cx="65" cy="45" r="5" fill="%23333"/%3E%3Cpath d="M 30 65 Q 50 75 70 65" stroke="%23f5576c" stroke-width="3" fill="none" stroke-linecap="round"/%3E%3Ccircle cx="25" cy="45" r="8" fill="%23ff9999" opacity="0.6"/%3E%3Ccircle cx="75" cy="45" r="8" fill="%23ff9999" opacity="0.6"/%3E%3C/svg%3E';
        };

        // ==================== å…³å¡æ•°æ® ====================
        let currentLevel = 1;
        
        // åŠ¨æ€è·å–åœ°é¢é«˜åº¦
        function getGroundY() {
            return canvas.height - 80;
        }
        
        const levels = {
            1: {
                name: "ğŸ’– å¯»æ‰¾é’¥åŒ™ç¢ç‰‡",
                description: "æ”¶é›†3ä¸ªé’¥åŒ™ç¢ç‰‡ï¼Œå›ç­”é—®é¢˜è·å¾—çˆ±ä¹‹é’¥åŒ™ï¼",
                width: 3000,
                getPlatforms: () => {
                    const groundY = getGroundY();
                    return [
                        { x: 0, y: groundY, width: 3000, height: 80 },
                        { x: 300, y: groundY - 150, width: 200, height: 20 },
                        { x: 600, y: groundY - 220, width: 150, height: 20 },
                        { x: 900, y: groundY - 280, width: 200, height: 20 },
                        { x: 1200, y: groundY - 220, width: 150, height: 20 },
                        { x: 1500, y: groundY - 150, width: 200, height: 20 },
                        { x: 1800, y: groundY - 220, width: 200, height: 20 },
                        { x: 2100, y: groundY - 280, width: 150, height: 20 },
                        { x: 2400, y: groundY - 200, width: 200, height: 20 },
                    ];
                },
                getEnemies: () => {
                    const groundY = getGroundY();
                    return [
                        { x: 500, y: groundY - 50, type: 'walk', speed: 0.8 },
                        { x: 800, y: groundY - 50, type: 'walk', speed: 0.8 },
                        { x: 1300, y: groundY - 50, type: 'walk', speed: 0.8 },
                        { x: 1900, y: groundY - 50, type: 'walk', speed: 0.8 },
                        { x: 2500, y: groundY - 50, type: 'walk', speed: 0.8 },
                    ];
                },
                getItems: () => {
                    const groundY = getGroundY();
                    return [
                        { x: 650, y: groundY - 280, type: 'keyFragment' },
                        { x: 1250, y: groundY - 280, type: 'keyFragment' },
                        { x: 2150, y: groundY - 340, type: 'keyFragment' },
                        { x: 400, y: groundY - 200, type: 'star' },
                        { x: 950, y: groundY - 340, type: 'star' },
                        { x: 1550, y: groundY - 210, type: 'star' },
                        { x: 1850, y: groundY - 280, type: 'star' },
                    ];
                },
                getQuestionBox: () => {
                    const groundY = getGroundY();
                    return { x: 2700, y: groundY - 270, asked: false, needsFragments: 3 };
                },
                getGoal: () => {
                    const groundY = getGroundY();
                    return { x: 2850, y: groundY - 80 };
                },
                specialMechanic: "æ”¶é›†é’¥åŒ™ç¢ç‰‡"
            },
            2: {
                name: "ğŸ” å¼€å¯å°å°ä¹‹é—¨",
                description: "ä½¿ç”¨çˆ±ä¹‹é’¥åŒ™æ‰“å¼€å°å°ä¹‹é—¨ï¼Œè·å¾—å®ˆæŠ¤ä¹‹ç›¾ï¼",
                width: 3500,
                getPlatforms: () => {
                    const groundY = getGroundY();
                    return [
                        { x: 0, y: groundY, width: 3500, height: 80 },
                        { x: 250, y: groundY - 150, width: 100, height: 20 },
                        { x: 450, y: groundY - 220, width: 100, height: 20 },
                        { x: 650, y: groundY - 280, width: 100, height: 20 },
                        { x: 850, y: groundY - 220, width: 150, height: 20 },
                        { x: 1100, y: groundY - 280, width: 100, height: 20 },
                        { x: 1350, y: groundY - 220, width: 150, height: 20 },
                        { x: 1650, y: groundY - 300, width: 200, height: 20 },
                        { x: 2000, y: groundY - 220, width: 150, height: 20 },
                        { x: 2300, y: groundY - 280, width: 100, height: 20 },
                        { x: 2600, y: groundY - 220, width: 200, height: 20 },
                        { x: 2950, y: groundY - 150, width: 200, height: 20 },
                    ];
                },
                getEnemies: () => {
                    const groundY = getGroundY();
                    return [
                        { x: 400, y: groundY - 50, type: 'walk', speed: 1.0 },
                        { x: 700, y: groundY - 50, type: 'walk', speed: 1.0 },
                        { x: 1000, y: groundY - 50, type: 'walk', speed: 1.0 },
                        { x: 1500, y: groundY - 50, type: 'walk', speed: 1.0 },
                        { x: 1800, y: groundY - 50, type: 'walk', speed: 1.0 },
                        { x: 2200, y: groundY - 50, type: 'walk', speed: 1.0 },
                        { x: 2700, y: groundY - 50, type: 'walk', speed: 1.0 },
                    ];
                },
                getItems: () => {
                    const groundY = getGroundY();
                    return [
                        { x: 300, y: groundY - 210, type: 'star' },
                        { x: 500, y: groundY - 280, type: 'star' },
                        { x: 700, y: groundY - 340, type: 'star' },
                        { x: 900, y: groundY - 280, type: 'star' },
                        { x: 1150, y: groundY - 340, type: 'star' },
                        { x: 1400, y: groundY - 280, type: 'star' },
                        { x: 2050, y: groundY - 280, type: 'star' },
                        { x: 2350, y: groundY - 340, type: 'star' },
                    ];
                },
                getLockedDoor: () => {
                    const groundY = getGroundY();
                    return { x: 1700, y: groundY - 230, width: 60, height: 100, opened: false };
                },
                getQuestionBox: () => {
                    const groundY = getGroundY();
                    return { x: 1750, y: groundY - 370, asked: false, needsKey: true };
                },
                getGoal: () => {
                    const groundY = getGroundY();
                    return { x: 3300, y: groundY - 80 };
                },
                specialMechanic: "æ‰“å¼€å°å°ä¹‹é—¨"
            },
            3: {
                name: "ğŸ›¡ï¸ å†³æˆ˜æ—¶å…‰å®ˆæŠ¤è€…",
                description: "ç”¨å®ˆæŠ¤ä¹‹ç›¾æŠµæŒ¡æ”»å‡»ï¼Œå‡»è´¥BOSSï¼",
                width: 1200,
                getPlatforms: () => {
                    const groundY = getGroundY();
                    return [
                        { x: 0, y: groundY, width: 1200, height: 80 },
                        { x: 150, y: groundY - 150, width: 150, height: 20 },
                        { x: 500, y: groundY - 220, width: 200, height: 20 },
                        { x: 900, y: groundY - 150, width: 150, height: 20 },
                    ];
                },
                getEnemies: () => [],
                getItems: () => {
                    const groundY = getGroundY();
                    return [
                        { x: 200, y: groundY - 210, type: 'heart' },
                        { x: 950, y: groundY - 210, type: 'heart' },
                    ];
                },
                getBoss: () => {
                    const groundY = getGroundY();
                    return {
                        x: 600,
                        y: groundY - 300,
                        width: 80,
                        height: 80,
                        hp: 10,
                        maxHp: 10,
                        vx: 2,
                        attackCooldown: 0,
                        projectiles: []
                    };
                },
                getGoal: () => null,
                specialMechanic: "ç”¨ç›¾ç‰ŒæŠµæŒ¡"
            }
        };

        // åˆå§‹åŒ–å½“å‰å…³å¡çš„æ•Œäººå’Œé“å…·
        let platforms = [];
        let enemies = [];
        let items = [];
        let questionBox = null;
        let goal = null;
        let boss = null;
        let lockedDoor = null;
        let keyFragments = 0;

        function loadLevel(levelNum) {
            currentLevel = levelNum;
            const levelData = levels[levelNum];
            
            // ä½¿ç”¨åŠ¨æ€å‡½æ•°è·å–å…³å¡æ•°æ®
            platforms = levelData.getPlatforms ? levelData.getPlatforms().map(p => ({...p})) : [];
            enemies = levelData.getEnemies ? levelData.getEnemies().map(e => ({
                ...e,
                width: 32,
                height: 32,
                vx: e.type === 'walk' ? -(e.speed || 2) : 0,
                alive: true
            })) : [];
            items = levelData.getItems ? levelData.getItems().map(i => ({
                ...i,
                width: i.type === 'keyFragment' ? 30 : 24,
                height: i.type === 'keyFragment' ? 30 : 24,
                collected: false,
                bounce: 0
            })) : [];
            
            const qBox = levelData.getQuestionBox ? levelData.getQuestionBox() : null;
            questionBox = qBox ? {...qBox, width: 40, height: 40} : null;
            
            const g = levelData.getGoal ? levelData.getGoal() : null;
            goal = g ? {...g, width: 60, height: 60} : null;
            
            boss = levelData.getBoss ? levelData.getBoss() : null;
            
            const lDoor = levelData.getLockedDoor ? levelData.getLockedDoor() : null;
            lockedDoor = lDoor ? {...lDoor} : null;
            
            // é‡ç½®å…³å¡ç‰¹å®šå˜é‡
            keyFragments = 0;
            
            // é‡ç½®ç©å®¶ä½ç½® - æ”¾åœ¨åœ°é¢ä¸Š
            const groundY = getGroundY();
            player.x = 100;
            player.y = groundY - player.height - 5;
            player.vx = 0;
            player.vy = 0;
            player.onGround = true;
            game.camera.x = 0;
            
            // ä¸æ˜¾ç¤ºå…³å¡æè¿°
        }

        // ==================== é—®é¢˜åº“ ====================
        const questions = {
            1: {
                question: "ğŸ’ ä½ æœ€å–œæ¬¢çš„æ˜¯è°ï¼Ÿ",
                answers: ["å¼ æ™ºéœ–", "é¹¿æ™—", "é‡‘åŸæ­¦"],
                correct: -1, // ä»»ä½•ç­”æ¡ˆéƒ½æ­£ç¡®
                reward: "çˆ±ä¹‹é’¥åŒ™",
                image: "second.jpg"
            },
            2: {
                question: "ğŸŒ¹ ä½ è€å…¬æœ€å–œæ¬¢çš„æ˜¯è°ï¼Ÿ",
                answers: ["è¿ªä¸½çƒ­å·´", "è¿ªä¸½çƒ­å¦ˆ", "æˆ‘"],
                correct: 2,
                reward: "å®ˆæŠ¤ä¹‹ç›¾",
                wrongHint: "æˆ‘å»ºè®®ä½ ç”¨ä½ èªæ…§çš„è„‘è¢‹å†æƒ³æƒ³",
                image: "avatar.jpg"
            },
            3: {
                question: "ğŸ’• æˆ‘ä»¬çš„æœªæ¥ä¼šæ˜¯ä»€ä¹ˆæ ·ï¼Ÿ",
                answers: ["å……æ»¡æŒ‘æˆ˜ä½†ä¸€èµ·é¢å¯¹", "ä¸çŸ¥é“", "éšé‡è€Œå®‰"],
                correct: 0,
                reward: null,
                image: "second.jpg"
            }
        };

        // ==================== è¾“å…¥æ§åˆ¶ ====================
        // é”®ç›˜æ§åˆ¶
        window.addEventListener('keydown', (e) => {
            game.keys[e.key] = true;
            if (e.key === ' ' || e.key === 'ArrowUp') {
                e.preventDefault();
                if (player.onGround) {
                    player.vy = player.jumpForce;
                }
            }
        });

        window.addEventListener('keyup', (e) => {
            game.keys[e.key] = false;
        });

        // è§¦æ‘¸æ§åˆ¶
        document.getElementById('btn-left').addEventListener('touchstart', (e) => {
            e.preventDefault();
            game.touchControls.left = true;
        });

        document.getElementById('btn-left').addEventListener('touchend', (e) => {
            e.preventDefault();
            game.touchControls.left = false;
        });

        document.getElementById('btn-right').addEventListener('touchstart', (e) => {
            e.preventDefault();
            game.touchControls.right = true;
        });

        document.getElementById('btn-right').addEventListener('touchend', (e) => {
            e.preventDefault();
            game.touchControls.right = false;
        });

        document.getElementById('btn-jump').addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (player.onGround && game.state === 'playing') {
                player.vy = player.jumpForce;
            }
        });
        
        // ä¸Šæ–¹å‘é”®ä¹Ÿå¯ä»¥è·³è·ƒ
        document.getElementById('btn-up').addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (player.onGround && game.state === 'playing') {
                player.vy = player.jumpForce;
            }
        });
        
        document.getElementById('btn-up').addEventListener('touchend', (e) => {
            e.preventDefault();
        });

        // é¼ æ ‡æ§åˆ¶ï¼ˆç”µè„‘ç«¯ï¼‰
        document.getElementById('btn-left').addEventListener('mousedown', () => game.touchControls.left = true);
        document.getElementById('btn-left').addEventListener('mouseup', () => game.touchControls.left = false);
        document.getElementById('btn-right').addEventListener('mousedown', () => game.touchControls.right = true);
        document.getElementById('btn-right').addEventListener('mouseup', () => game.touchControls.right = false);
        document.getElementById('btn-jump').addEventListener('mousedown', () => {
            if (player.onGround && game.state === 'playing') player.vy = player.jumpForce;
        });
        
        // ä¸Šæ–¹å‘é”®é¼ æ ‡æ§åˆ¶
        document.getElementById('btn-up').addEventListener('mousedown', () => {
            if (player.onGround && game.state === 'playing') player.vy = player.jumpForce;
        });

        // ==================== ç¢°æ’æ£€æµ‹ ====================
        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }

        // ==================== æ¸¸æˆé€»è¾‘ ====================
        function update() {
            if (game.state !== 'playing') return;

            // æ›´æ–°è®¡æ—¶å™¨
            const elapsed = Math.floor((Date.now() - game.startTime) / 1000);
            document.getElementById('timer').textContent = elapsed;

            // ç©å®¶ç§»åŠ¨
            player.vx = 0;
            if (game.keys['ArrowLeft'] || game.keys['a'] || game.touchControls.left) {
                player.vx = -player.speed;
                player.direction = -1;
            }
            if (game.keys['ArrowRight'] || game.keys['d'] || game.touchControls.right) {
                player.vx = player.speed;
                player.direction = 1;
            }

            // é‡åŠ›
            player.vy += game.gravity;
            player.vy = Math.min(player.vy, 15); // æœ€å¤§ä¸‹è½é€Ÿåº¦

            // æ›´æ–°ä½ç½®
            player.x += player.vx;
            player.y += player.vy;
            
            // ç¡®ä¿ç©å®¶ä¸ä¼šåœ¨åˆå§‹åŒ–æ—¶å°±æ‰è½
            if (!platforms || platforms.length === 0) return;

            // ç¢°æ’æ£€æµ‹ - å¹³å°
            player.onGround = false;
            platforms.forEach(platform => {
                if (checkCollision(player, platform)) {
                    // ä»ä¸Šæ–¹è½ä¸‹
                    if (player.vy > 0 && player.y + player.height - player.vy <= platform.y + 5) {
                        player.y = platform.y - player.height;
                        player.vy = 0;
                        player.onGround = true;
                    }
                    // ä»ä¸‹æ–¹æ’å‡»
                    else if (player.vy < 0 && player.y - player.vy >= platform.y + platform.height) {
                        player.y = platform.y + platform.height;
                        player.vy = 0;
                    }
                }
            });

            // è¾¹ç•Œæ£€æµ‹
            if (player.x < 0) player.x = 0;
            if (levels[currentLevel] && player.x > levels[currentLevel].width - player.width) {
                player.x = levels[currentLevel].width - player.width;
            }

            // æ‰è½æ­»äº¡ - å¢åŠ å®¹é”™ï¼Œåªæœ‰åœ¨æ¸¸æˆçœŸæ­£å¼€å§‹åæ‰åˆ¤æ–­
            if (player.y > canvas.height + 100) {
                takeDamage();
            }

            // æ— æ•Œæ—¶é—´é€’å‡
            if (player.invincible > 0) player.invincible--;

            // æ›´æ–°æ•Œäºº
            enemies.forEach(enemy => {
                if (!enemy.alive) return;

                enemy.x += enemy.vx;

                // æ•Œäººè½¬å‘
                if (enemy.type === 'walk') {
                    if (enemy.x < 50 || enemy.x > levels[currentLevel].width - 50) {
                        enemy.vx = -enemy.vx;
                    }
                }

                // ç©å®¶ç¢°åˆ°æ•Œäºº
                if (checkCollision(player, enemy) && player.invincible === 0) {
                    // ä»ä¸Šæ–¹è¸©åˆ°
                    if (player.vy > 0 && player.y < enemy.y) {
                        enemy.alive = false;
                        player.vy = -8;
                        game.stars += 1;
                    } else {
                        takeDamage();
                    }
                }
            });

            // æ›´æ–°é“å…·
            items.forEach(item => {
                if (item.collected) return;
                
                item.bounce += 0.1;

                if (checkCollision(player, item) && !item.collected) {
                    item.collected = true;
                    
                    // æ·»åŠ æ”¶é›†éŸ³æ•ˆæç¤ºå’Œè§†è§‰åé¦ˆï¼ˆä¸æ˜¾ç¤ºå¼¹çª—ï¼‰
                    if (item.type === 'star') {
                        game.stars += 1;
                    } else if (item.type === 'heart') {
                        game.hearts = Math.min(3, game.hearts + 1);
                    } else if (item.type === 'keyFragment') {
                        keyFragments += 1;
                    }
                }
            });

            // é—®å·ç®±
            if (questionBox && !questionBox.asked && checkCollision(player, questionBox)) {
                // å…³å¡1ï¼šéœ€è¦æ”¶é›†è¶³å¤Ÿçš„é’¥åŒ™ç¢ç‰‡
                if (questionBox.needsFragments && keyFragments < questionBox.needsFragments) {
                    // ä¸æ˜¾ç¤ºæç¤º
                }
                // å…³å¡2ï¼šéœ€è¦é’¥åŒ™æ‰èƒ½æ‰“å¼€
                else if (questionBox.needsKey && player.weapon !== 'çˆ±ä¹‹é’¥åŒ™') {
                    // ä¸æ˜¾ç¤ºæç¤º
                }
                else {
                    showQuestion();
                    questionBox.asked = true;
                }
            }

            // å°å°ä¹‹é—¨ï¼ˆå…³å¡2ï¼‰
            if (lockedDoor && !lockedDoor.opened) {
                if (checkCollision(player, lockedDoor)) {
                    if (player.weapon === 'çˆ±ä¹‹é’¥åŒ™') {
                        lockedDoor.opened = true;
                        
                        // å¯åŠ¨ç«ç®­ä¼ é€å®ç®±åŠ¨ç”»
                        if (questionBox && !questionBox.asked) {
                            startRocketAnimation();
                        }
                    } else {
                        // é˜»æŒ¡ç©å®¶
                        if (player.x + player.width > lockedDoor.x && player.x < lockedDoor.x + lockedDoor.width / 2) {
                            player.x = lockedDoor.x - player.width;
                        }
                    }
                }
            }
            
            // æ›´æ–°ç«ç®­åŠ¨ç”»
            if (questionBox && questionBox.rocketAnimation) {
                updateRocketAnimation();
            }

            // ç»ˆç‚¹
            if (goal && checkCollision(player, goal)) {
                nextLevel();
            }

            // BOSSæˆ˜é€»è¾‘
            if (boss && boss.hp > 0) {
                boss.x += boss.vx;
                
                if (boss.x < 100 || boss.x > levels[currentLevel].width - 100) {
                    boss.vx = -boss.vx;
                }

                // BOSSå‘å°„å¼¹å¹•
                boss.attackCooldown--;
                if (boss.attackCooldown <= 0) {
                    boss.attackCooldown = 90; // æ¯1.5ç§’å‘å°„ä¸€æ¬¡
                    const angle = Math.atan2(player.y - boss.y, player.x - boss.x);
                    boss.projectiles.push({
                        x: boss.x + boss.width / 2,
                        y: boss.y + boss.height / 2,
                        vx: Math.cos(angle) * 4,
                        vy: Math.sin(angle) * 4,
                        width: 20,
                        height: 20
                    });
                }

                // æ›´æ–°å¼¹å¹•
                for (let i = boss.projectiles.length - 1; i >= 0; i--) {
                    const proj = boss.projectiles[i];
                    proj.x += proj.vx;
                    proj.y += proj.vy;

                    // å¼¹å¹•ç¢°åˆ°ç©å®¶
                    if (checkCollision(player, proj)) {
                        boss.projectiles.splice(i, 1);
                        // å¦‚æœæœ‰ç›¾ç‰Œï¼Œå¯ä»¥æŠµæŒ¡
                        if (player.weapon === 'å®ˆæŠ¤ä¹‹ç›¾') {
                            // ç›¾ç‰ŒæŠµæŒ¡ï¼Œä¸æ˜¾ç¤ºæç¤º
                        } else if (player.invincible === 0) {
                            takeDamage();
                        }
                    }
                    // å¼¹å¹•é£å‡ºå±å¹•
                    else if (proj.x < 0 || proj.x > levels[currentLevel].width || proj.y < 0 || proj.y > canvas.height) {
                        boss.projectiles.splice(i, 1);
                    }
                }

                // ç©å®¶æ”»å‡»BOSS
                if (checkCollision(player, boss)) {
                    if (player.vy > 0 && player.y < boss.y) {
                        boss.hp--;
                        player.vy = -10;
                        
                        // åˆ›å»ºæ”»å‡»ç‰¹æ•ˆ
                        createAttackEffect(boss.x + boss.width / 2, boss.y + boss.height / 2);
                        
                        if (boss.hp <= 0) {
                            // åˆ›å»ºèƒœåˆ©ç‰¹æ•ˆ
                            createVictoryEffect();
                            setTimeout(() => {
                                showEnding();
                            }, 1000);
                        }
                    } else if (player.invincible === 0) {
                        // å¦‚æœæœ‰ç›¾ç‰Œï¼Œå‡å°‘ä¼¤å®³
                        if (player.weapon === 'å®ˆæŠ¤ä¹‹ç›¾') {
                            player.invincible = 60;
                        } else {
                            takeDamage();
                        }
                    }
                }
            }

            // æ›´æ–°æ‘„åƒæœº
            updateCamera();

            // æ›´æ–°HUD
            document.getElementById('hearts').textContent = game.hearts;
            document.getElementById('stars').textContent = game.stars;
            
            // æ›´æ–°æ­¦å™¨æ˜¾ç¤º
            if (player.weapon) {
                const weaponEmoji = player.weapon === 'çˆ±ä¹‹é’¥åŒ™' ? 'ğŸ”‘' : player.weapon === 'å®ˆæŠ¤ä¹‹ç›¾' ? 'ğŸ›¡ï¸' : 'ğŸ';
                document.getElementById('weapon-name').textContent = weaponEmoji;
                document.getElementById('weapon-display').style.display = 'block';
            } else {
                document.getElementById('weapon-display').style.display = 'none';
            }
            
            // æ›´æ–°é’¥åŒ™ç¢ç‰‡æ˜¾ç¤º
            if (currentLevel === 1) {
                document.getElementById('fragments').textContent = keyFragments;
                document.getElementById('fragment-display').style.display = 'block';
            } else {
                document.getElementById('fragment-display').style.display = 'none';
            }
        }

        function updateCamera() {
            // æ‘„åƒæœºè·Ÿéšç©å®¶
            const targetX = player.x - canvas.width / 2 + player.width / 2;
            game.camera.x = Math.max(0, Math.min(targetX, levels[currentLevel].width - canvas.width));
        }

        function takeDamage() {
            if (game.hearts <= 0) return; // é˜²æ­¢é‡å¤è°ƒç”¨
            
            game.hearts--;
            player.invincible = 60;
            
            if (game.hearts <= 0) {
                setTimeout(() => {
                    alert('æ¸¸æˆç»“æŸï¼å†æ¥ä¸€æ¬¡å§ï¼');
                    restartGame();
                }, 100);
            } else {
                // é‡ç”Ÿåœ¨åœ°é¢ä¸Š
                const groundY = getGroundY();
                player.x = 100;
                player.y = groundY - player.height - 5;
                player.vx = 0;
                player.vy = 0;
                player.onGround = true;
                game.camera.x = 0;
            }
        }

        // ==================== æ¸²æŸ“ ====================
        function render() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = '#5c94fc';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // å¦‚æœæ¸¸æˆè¿˜æ²¡å¼€å§‹ï¼Œåªæ˜¾ç¤ºèƒŒæ™¯
            if (game.state === 'start' || !levels[currentLevel]) {
                return;
            }

            ctx.save();
            ctx.translate(-game.camera.x, 0);

            // ç»˜åˆ¶èƒŒæ™¯äº‘æœµ
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            for (let i = 0; i < 5; i++) {
                const cloudX = (i * 300 + game.camera.x * 0.5) % (levels[currentLevel].width + 300);
                drawCloud(cloudX, 80 + i * 40);
            }

            // ç»˜åˆ¶å¹³å°
            ctx.fillStyle = '#8B4513';
            ctx.strokeStyle = '#654321';
            ctx.lineWidth = 2;
            platforms.forEach(platform => {
                ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                ctx.strokeRect(platform.x, platform.y, platform.width, platform.height);
                
                // è‰åœ°è£…é¥°
                if (platform.height > 30) {
                    ctx.fillStyle = '#228B22';
                    ctx.fillRect(platform.x, platform.y, platform.width, 8);
                    ctx.fillStyle = '#8B4513';
                }
            });

            // ç»˜åˆ¶é“å…·
            items.forEach(item => {
                if (item.collected) return;
                
                const bounceY = Math.sin(item.bounce) * 5;
                
                if (item.type === 'star') {
                    drawStar(item.x + 12, item.y + 12 + bounceY, 12, '#FFD700');
                } else if (item.type === 'heart') {
                    drawHeart(item.x + 12, item.y + 12 + bounceY, '#FF69B4');
                } else if (item.type === 'keyFragment') {
                    drawKeyFragment(item.x + 15, item.y + 15 + bounceY);
                }
            });

            // ç»˜åˆ¶å°å°ä¹‹é—¨
            if (lockedDoor && !lockedDoor.opened) {
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(lockedDoor.x, lockedDoor.y, lockedDoor.width, lockedDoor.height);
                ctx.strokeStyle = '#654321';
                ctx.lineWidth = 4;
                ctx.strokeRect(lockedDoor.x, lockedDoor.y, lockedDoor.width, lockedDoor.height);
                
                // é—¨ä¸Šçš„é”
                ctx.fillStyle = '#FFD700';
                ctx.beginPath();
                ctx.arc(lockedDoor.x + lockedDoor.width / 2, lockedDoor.y + 40, 15, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillRect(lockedDoor.x + lockedDoor.width / 2 - 8, lockedDoor.y + 45, 16, 20);
                ctx.fillStyle = '#8B4513';
                ctx.beginPath();
                ctx.arc(lockedDoor.x + lockedDoor.width / 2, lockedDoor.y + 40, 8, 0, Math.PI * 2);
                ctx.fill();
                
                // é—¨çš„è£…é¥°
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 2;
                ctx.strokeRect(lockedDoor.x + 5, lockedDoor.y + 5, lockedDoor.width - 10, lockedDoor.height - 10);
            }

            // ç»˜åˆ¶é—®å·ç®±
            if (questionBox && !questionBox.asked) {
                // å…³å¡2ï¼šåªæœ‰åœ¨é—¨æ‰“å¼€åæ‰æ˜¾ç¤ºé—®å·ç®±
                if (currentLevel === 2 && lockedDoor && !lockedDoor.opened) {
                    // ä¸æ˜¾ç¤ºé—®å·ç®±
                } else {
                    // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ‰“å¼€
                    let canOpen = true;
                    if (questionBox.needsFragments && keyFragments < questionBox.needsFragments) {
                        canOpen = false;
                        ctx.fillStyle = '#888';
                    } else if (questionBox.needsKey && player.weapon !== 'çˆ±ä¹‹é’¥åŒ™') {
                        canOpen = false;
                        ctx.fillStyle = '#888';
                    } else {
                        ctx.fillStyle = '#FFD700';
                    }
                    
                    // å¦‚æœæœ‰ç«ç®­åŠ¨ç”»ï¼Œåº”ç”¨åç§»
                    let boxX = questionBox.x;
                    let boxY = questionBox.y;
                    if (questionBox.rocketAnimation) {
                        boxX = questionBox.rocketX;
                        boxY = questionBox.rocketY;
                        
                        // ç»˜åˆ¶ç«ç®­
                        drawRocket(boxX + 20, boxY - 30);
                    }
                    
                    ctx.fillRect(boxX, boxY, questionBox.width, questionBox.height);
                    ctx.strokeStyle = canOpen ? '#FF8C00' : '#555';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(boxX, boxY, questionBox.width, questionBox.height);
                    ctx.fillStyle = canOpen ? '#FF4500' : '#333';
                    ctx.font = 'bold 30px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('?', boxX + 20, boxY + 30);
                }
            }

            // ç»˜åˆ¶ç»ˆç‚¹
            if (goal) {
                drawFlag(goal.x, goal.y);
            }

            // ç»˜åˆ¶æ•Œäºº
            enemies.forEach(enemy => {
                if (!enemy.alive) return;
                drawEnemy(enemy.x, enemy.y, enemy.width, enemy.height);
            });

            // ç»˜åˆ¶BOSSå¼¹å¹•
            if (boss && boss.projectiles) {
                boss.projectiles.forEach(proj => {
                    ctx.fillStyle = '#FF00FF';
                    ctx.beginPath();
                    ctx.arc(proj.x, proj.y, proj.width / 2, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.strokeStyle = '#FF1493';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                });
            }

            // ç»˜åˆ¶BOSS
            if (boss && boss.hp > 0) {
                drawBoss(boss.x, boss.y, boss.width, boss.height);
                
                // BOSSè¡€æ¡
                const hpBarWidth = 100;
                const hpBarHeight = 8;
                ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
                ctx.fillRect(boss.x - 10, boss.y - 20, hpBarWidth, hpBarHeight);
                ctx.fillStyle = '#FF0000';
                ctx.fillRect(boss.x - 10, boss.y - 20, hpBarWidth * (boss.hp / boss.maxHp), hpBarHeight);
            }

            // ç»˜åˆ¶ç©å®¶
            if (player.invincible % 4 < 2) { // æ— æ•Œé—ªçƒæ•ˆæœ
                drawPlayer(player.x, player.y, player.width, player.height, player.direction);
            }
            
            // ç»˜åˆ¶ç‰¹æ•ˆ
            renderEffects();

            ctx.restore();

            // ç»˜åˆ¶å…³å¡åç§°
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(10, canvas.height - 50, 200, 40);
            ctx.fillStyle = 'white';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(levels[currentLevel].name, 20, canvas.height - 25);
            
            // ç»˜åˆ¶æç¤º
            renderHint();
        }

        // ==================== ç»˜åˆ¶å‡½æ•° ====================
        function drawPlayer(x, y, w, h, dir) {
            // ç«æŸ´äººèº«ä½“ï¼ˆçº¿æ¡ï¼‰
            ctx.strokeStyle = '#FF69B4';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            
            const headSize = 18;
            const bodyStart = y + headSize * 2;
            const bodyEnd = y + h - 12;
            const centerX = x + w / 2;
            
            // èº«ä½“ï¼ˆç«–çº¿ï¼‰
            ctx.beginPath();
            ctx.moveTo(centerX, bodyStart);
            ctx.lineTo(centerX, bodyEnd - 8);
            ctx.stroke();
            
            // æ‰‹è‡‚
            const armY = bodyStart + 8;
            ctx.beginPath();
            ctx.moveTo(centerX - 12, armY - 5);
            ctx.lineTo(centerX, armY);
            ctx.lineTo(centerX + 12 * dir, armY - 5);
            ctx.stroke();
            
            // è…¿ï¼ˆèµ°è·¯åŠ¨ç”»ï¼‰
            const legOffset = Math.sin(Date.now() * 0.01) * 3;
            ctx.beginPath();
            ctx.moveTo(centerX, bodyEnd - 8);
            ctx.lineTo(centerX - 8, bodyEnd + legOffset);
            ctx.moveTo(centerX, bodyEnd - 8);
            ctx.lineTo(centerX + 8, bodyEnd - legOffset);
            ctx.stroke();
            
            // å¤´éƒ¨ï¼ˆä½¿ç”¨å›¾ç‰‡ï¼‰
            if (playerAvatar.complete && playerAvatar.naturalWidth > 0) {
                ctx.save();
                
                // ç»˜åˆ¶åœ†å½¢å¤´åƒ
                const avatarSize = headSize * 2.2; // ç¨å¾®å¤§ä¸€ç‚¹çš„å¤´åƒ
                const avatarX = centerX;
                const avatarY = y + headSize;
                
                // åˆ›å»ºåœ†å½¢è£å‰ªåŒºåŸŸ
                ctx.beginPath();
                ctx.arc(avatarX, avatarY, headSize, 0, Math.PI * 2);
                ctx.closePath();
                ctx.clip();
                
                // ç»˜åˆ¶å¤´åƒï¼ˆå±…ä¸­ï¼‰
                if (dir === -1) {
                    ctx.scale(-1, 1);
                    ctx.drawImage(playerAvatar, -avatarX - headSize, avatarY - headSize, avatarSize, avatarSize);
                } else {
                    ctx.drawImage(playerAvatar, avatarX - headSize, avatarY - headSize, avatarSize, avatarSize);
                }
                
                ctx.restore();
                
                // ç»˜åˆ¶å¤´åƒè¾¹æ¡†
                ctx.strokeStyle = '#FF69B4';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(avatarX, avatarY, headSize, 0, Math.PI * 2);
                ctx.stroke();
            } else {
                // å¤‡ç”¨åœ†å½¢å¤´éƒ¨
                ctx.fillStyle = '#FFB6C1';
                ctx.beginPath();
                ctx.arc(centerX, y + headSize, headSize, 0, Math.PI * 2);
                ctx.fill();
                
                // ç®€å•çš„è„¸
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(centerX - 5, y + headSize - 2, 2, 0, Math.PI * 2);
                ctx.arc(centerX + 5, y + headSize - 2, 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(centerX, y + headSize + 5, 8, 0, Math.PI);
                ctx.stroke();
            }
            
            // æ˜¾ç¤ºæ­¦å™¨
            if (player.weapon) {
                ctx.font = 'bold 16px Arial';
                ctx.fillStyle = '#FFD700';
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.textAlign = 'center';
                const weaponText = player.weapon === 'çˆ±ä¹‹é’¥åŒ™' ? 'ğŸ”‘' : player.weapon === 'å®ˆæŠ¤ä¹‹ç›¾' ? 'ğŸ›¡ï¸' : '';
                ctx.strokeText(weaponText, centerX + 20 * dir, armY - 10);
                ctx.fillText(weaponText, centerX + 20 * dir, armY - 10);
            }
        }

        function drawEnemy(x, y, w, h) {
            // èº«ä½“
            ctx.fillStyle = '#8B008B';
            ctx.beginPath();
            ctx.arc(x + w/2, y + h/2, w/2, 0, Math.PI * 2);
            ctx.fill();
            
            // çœ¼ç›
            ctx.fillStyle = '#FFF';
            ctx.fillRect(x + 8, y + 10, 6, 6);
            ctx.fillRect(x + 18, y + 10, 6, 6);
            ctx.fillStyle = '#000';
            ctx.fillRect(x + 10, y + 12, 3, 3);
            ctx.fillRect(x + 20, y + 12, 3, 3);
            
            // è„š
            ctx.fillStyle = '#4B0082';
            ctx.fillRect(x + 6, y + h - 6, 8, 6);
            ctx.fillRect(x + w - 14, y + h - 6, 8, 6);
        }

        function drawBoss(x, y, w, h) {
            // BOSSèº«ä½“
            ctx.fillStyle = '#FF0000';
            ctx.fillRect(x, y + 10, w, h - 10);
            
            // å¤´
            ctx.fillStyle = '#FF4500';
            ctx.beginPath();
            ctx.arc(x + w/2, y + 20, 25, 0, Math.PI * 2);
            ctx.fill();
            
            // è§’
            ctx.fillStyle = '#8B0000';
            ctx.beginPath();
            ctx.moveTo(x + 15, y + 10);
            ctx.lineTo(x + 20, y);
            ctx.lineTo(x + 25, y + 10);
            ctx.fill();
            ctx.beginPath();
            ctx.moveTo(x + w - 25, y + 10);
            ctx.lineTo(x + w - 20, y);
            ctx.lineTo(x + w - 15, y + 10);
            ctx.fill();
            
            // çœ¼ç›
            ctx.fillStyle = '#FFF';
            ctx.fillRect(x + 20, y + 20, 10, 10);
            ctx.fillRect(x + 50, y + 20, 10, 10);
            ctx.fillStyle = '#000';
            ctx.fillRect(x + 23, y + 23, 5, 5);
            ctx.fillRect(x + 53, y + 23, 5, 5);
        }

        function drawStar(x, y, radius, color) {
            ctx.fillStyle = color;
            ctx.beginPath();
            for (let i = 0; i < 5; i++) {
                const angle = (i * 4 * Math.PI) / 5 - Math.PI / 2;
                const px = x + Math.cos(angle) * radius;
                const py = y + Math.sin(angle) * radius;
                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            }
            ctx.closePath();
            ctx.fill();
        }

        function drawHeart(x, y, color) {
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.moveTo(x, y + 5);
            ctx.bezierCurveTo(x, y, x - 7, y - 5, x - 10, y - 5);
            ctx.bezierCurveTo(x - 15, y - 5, x - 15, y + 2, x - 15, y + 2);
            ctx.bezierCurveTo(x - 15, y + 8, x - 10, y + 12, x, y + 18);
            ctx.bezierCurveTo(x + 10, y + 12, x + 15, y + 8, x + 15, y + 2);
            ctx.bezierCurveTo(x + 15, y + 2, x + 15, y - 5, x + 10, y - 5);
            ctx.bezierCurveTo(x + 7, y - 5, x, y, x, y + 5);
            ctx.fill();
        }

        function drawKeyFragment(x, y) {
            // é’¥åŒ™ç¢ç‰‡ - é‡‘è‰²çš„ç¢ç‰‡
            ctx.fillStyle = '#FFD700';
            ctx.strokeStyle = '#FF8C00';
            ctx.lineWidth = 2;
            
            // ä¸»ä½“
            ctx.beginPath();
            ctx.arc(x, y, 8, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            
            // é—ªå…‰æ•ˆæœ
            ctx.fillStyle = '#FFF';
            ctx.beginPath();
            ctx.arc(x - 3, y - 3, 3, 0, Math.PI * 2);
            ctx.fill();
            
            // é’¥åŒ™é½¿
            ctx.fillStyle = '#FFD700';
            ctx.fillRect(x - 2, y + 5, 4, 8);
            ctx.fillRect(x - 2, y + 10, 6, 3);
            ctx.strokeStyle = '#FF8C00';
            ctx.strokeRect(x - 2, y + 5, 4, 8);
        }

        function drawCloud(x, y) {
            ctx.beginPath();
            ctx.arc(x, y, 20, 0, Math.PI * 2);
            ctx.arc(x + 25, y, 25, 0, Math.PI * 2);
            ctx.arc(x + 50, y, 20, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawFlag(x, y) {
            // æ——æ†
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(x + 25, y, 5, 60);
            
            // æ——å¸œ
            ctx.fillStyle = '#FF1493';
            ctx.beginPath();
            ctx.moveTo(x + 30, y + 5);
            ctx.lineTo(x + 55, y + 15);
            ctx.lineTo(x + 30, y + 25);
            ctx.closePath();
            ctx.fill();
            
            // ç¤¼ç‰©ç›’
            ctx.fillStyle = '#FFD700';
            ctx.fillRect(x + 5, y + 40, 40, 40);
            ctx.fillStyle = '#FF4500';
            ctx.fillRect(x + 20, y + 40, 10, 40);
            ctx.fillRect(x + 5, y + 55, 40, 10);
            
            // è´è¶ç»“
            ctx.fillStyle = '#FF0000';
            ctx.fillRect(x + 18, y + 35, 14, 8);
        }

        // ==================== é—®ç­”ç³»ç»Ÿ ====================
        function showQuestion() {
            game.state = 'question';
            const modal = document.getElementById('question-modal');
            const questionText = document.getElementById('question-text');
            const questionImage = document.getElementById('question-image');
            const answerButtons = document.getElementById('answer-buttons');
            
            const q = questions[currentLevel];
            questionText.textContent = q.question;
            
            // æ˜¾ç¤ºé—®é¢˜å›¾ç‰‡
            if (q.image) {
                questionImage.src = q.image;
                questionImage.style.display = 'block';
            } else {
                questionImage.style.display = 'none';
            }
            
            answerButtons.innerHTML = '';
            q.answers.forEach((answer, index) => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.textContent = answer;
                btn.onclick = () => checkAnswer(index, btn, q.correct, q.reward, answer, q.wrongHint);
                answerButtons.appendChild(btn);
            });
            
            modal.classList.add('active');
        }

        function checkAnswer(index, btn, correct, reward, selectedAnswer, wrongHint) {
            const q = questions[currentLevel];
            
            // ç¬¬ä¸€å…³ï¼šä»»ä½•ç­”æ¡ˆéƒ½æ­£ç¡®
            if (currentLevel === 1) {
                btn.classList.add('correct');
                game.stars += 3;
                game.hearts = Math.min(3, game.hearts + 1);
                
                // è·å¾—æ­¦å™¨
                if (reward) {
                    player.weapon = reward;
                    const weaponEmoji = reward === 'çˆ±ä¹‹é’¥åŒ™' ? 'ğŸ”‘' : reward === 'å®ˆæŠ¤ä¹‹ç›¾' ? 'ğŸ›¡ï¸' : '';
                    showHint(`ğŸ‰ ç­”æ¡ˆæ­£ç¡®ï¼Œå°±æ˜¯é•¿å¾—åƒ${selectedAnswer}çš„èˆœå“¥ï¼Œä½ è·å¾—äº† ${weaponEmoji} ${reward}ï¼`, 3000, true);
                }
                
                setTimeout(() => {
                    closeQuestion();
                }, 2000);
            }
            // ç¬¬äºŒå…³ï¼šå¿…é¡»é€‰"æˆ‘"
            else if (currentLevel === 2) {
                if (index === correct) {
                    btn.classList.add('correct');
                    game.stars += 3;
                    game.hearts = Math.min(3, game.hearts + 1);
                    
                    // è·å¾—æ­¦å™¨
                    if (reward) {
                        player.weapon = reward;
                        const weaponEmoji = reward === 'çˆ±ä¹‹é’¥åŒ™' ? 'ğŸ”‘' : reward === 'å®ˆæŠ¤ä¹‹ç›¾' ? 'ğŸ›¡ï¸' : '';
                        showHint(`ğŸ‰ æœç„¶æ˜¯åŒå‘å¥”èµ´çš„çˆ±æƒ…ï¼Œæ­å–œä½ è·å¾—äº† ${weaponEmoji} ${reward}ï¼`, 3000, true);
                    }
                    
                    setTimeout(() => {
                        closeQuestion();
                    }, 2000);
                } else {
                    btn.classList.add('wrong');
                    showHint(wrongHint || 'ç­”æ¡ˆä¸å¯¹å“¦ï¼', 2000, true);
                    setTimeout(() => {
                        btn.classList.remove('wrong');
                    }, 500);
                }
            }
            // å…¶ä»–å…³å¡
            else {
                if (index === correct) {
                    btn.classList.add('correct');
                    game.stars += 3;
                    game.hearts = Math.min(3, game.hearts + 1);
                    
                    // è·å¾—æ­¦å™¨
                    if (reward) {
                        player.weapon = reward;
                        const weaponEmoji = reward === 'çˆ±ä¹‹é’¥åŒ™' ? 'ğŸ”‘' : reward === 'å®ˆæŠ¤ä¹‹ç›¾' ? 'ğŸ›¡ï¸' : '';
                        showHint(`ğŸ‰ è·å¾—äº† ${weaponEmoji} ${reward}ï¼`, 3000, true);
                    }
                    
                    setTimeout(() => {
                        closeQuestion();
                    }, 1500);
                } else {
                    btn.classList.add('wrong');
                    setTimeout(() => {
                        btn.classList.remove('wrong');
                    }, 500);
                }
            }
        }

        function closeQuestion() {
            document.getElementById('question-modal').classList.remove('active');
            game.state = 'playing';
        }

        // ==================== å…³å¡åˆ‡æ¢ ====================
        function nextLevel() {
            if (currentLevel < 3) {
                currentLevel++;
                loadLevel(currentLevel);
            } else {
                showEnding();
            }
        }

        // ==================== ç»“å±€ ====================
        function showEnding() {
            game.state = 'ending';
            document.getElementById('final-stars').textContent = game.stars;
            document.getElementById('ending-screen').classList.add('active');
            startFireworks();
        }

        function startFireworks() {
            const fireworksCanvas = document.getElementById('fireworks-canvas');
            fireworksCanvas.width = window.innerWidth;
            fireworksCanvas.height = window.innerHeight;
            const fctx = fireworksCanvas.getContext('2d');
            
            const particles = [];
            
            function createFirework() {
                const x = Math.random() * fireworksCanvas.width;
                const y = Math.random() * fireworksCanvas.height * 0.5;
                const colors = ['#FF69B4', '#FFD700', '#FF1493', '#FFA500', '#FF6347'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                for (let i = 0; i < 30; i++) {
                    particles.push({
                        x: x,
                        y: y,
                        vx: (Math.random() - 0.5) * 8,
                        vy: (Math.random() - 0.5) * 8,
                        life: 60,
                        color: color
                    });
                }
            }
            
            let fireworkInterval = setInterval(createFirework, 500);
            
            function animateFireworks() {
                fctx.fillStyle = 'rgba(255, 236, 210, 0.1)';
                fctx.fillRect(0, 0, fireworksCanvas.width, fireworksCanvas.height);
                
                for (let i = particles.length - 1; i >= 0; i--) {
                    const p = particles[i];
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.2;
                    p.life--;
                    
                    if (p.life <= 0) {
                        particles.splice(i, 1);
                        continue;
                    }
                    
                    fctx.fillStyle = p.color;
                    fctx.globalAlpha = p.life / 60;
                    fctx.beginPath();
                    fctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
                    fctx.fill();
                }
                
                fctx.globalAlpha = 1;
                
                if (game.state === 'ending') {
                    requestAnimationFrame(animateFireworks);
                } else {
                    clearInterval(fireworkInterval);
                }
            }
            
            animateFireworks();
        }

        // ==================== ç«ç®­ä¼ é€åŠ¨ç”» ====================
        function startRocketAnimation() {
            if (!questionBox) return;
            
            questionBox.rocketAnimation = true;
            questionBox.rocketStartX = questionBox.x;
            questionBox.rocketStartY = questionBox.y;
            questionBox.rocketX = questionBox.x;
            questionBox.rocketY = questionBox.y;
            questionBox.rocketTargetX = player.x + 100;
            questionBox.rocketTargetY = player.y - 100;
            questionBox.rocketProgress = 0;
        }
        
        function updateRocketAnimation() {
            if (!questionBox || !questionBox.rocketAnimation) return;
            
            questionBox.rocketProgress += 0.02;
            
            if (questionBox.rocketProgress >= 1) {
                // åŠ¨ç”»ç»“æŸ
                questionBox.rocketAnimation = false;
                questionBox.x = questionBox.rocketTargetX;
                questionBox.y = questionBox.rocketTargetY;
            } else {
                // ä½¿ç”¨ç¼“åŠ¨å‡½æ•°
                const t = questionBox.rocketProgress;
                const easeOut = 1 - Math.pow(1 - t, 3);
                
                questionBox.rocketX = questionBox.rocketStartX + (questionBox.rocketTargetX - questionBox.rocketStartX) * easeOut;
                questionBox.rocketY = questionBox.rocketStartY + (questionBox.rocketTargetY - questionBox.rocketStartY) * easeOut;
                
                // æ·»åŠ ä¸Šä¸‹æµ®åŠ¨æ•ˆæœ
                questionBox.rocketY += Math.sin(t * Math.PI * 4) * 10;
            }
        }
        
        function drawRocket(x, y) {
            ctx.save();
            
            // ç«ç®­å°¾ç„°
            ctx.fillStyle = '#FF6347';
            ctx.beginPath();
            ctx.moveTo(x, y + 30);
            ctx.lineTo(x - 8, y + 45);
            ctx.lineTo(x + 8, y + 45);
            ctx.closePath();
            ctx.fill();
            
            ctx.fillStyle = '#FFA500';
            ctx.beginPath();
            ctx.moveTo(x, y + 35);
            ctx.lineTo(x - 5, y + 45);
            ctx.lineTo(x + 5, y + 45);
            ctx.closePath();
            ctx.fill();
            
            // ç«ç®­èº«ä½“
            ctx.fillStyle = '#FF4500';
            ctx.fillRect(x - 10, y, 20, 30);
            
            // ç«ç®­å¤´éƒ¨
            ctx.fillStyle = '#DC143C';
            ctx.beginPath();
            ctx.moveTo(x, y - 15);
            ctx.lineTo(x - 10, y);
            ctx.lineTo(x + 10, y);
            ctx.closePath();
            ctx.fill();
            
            // ç«ç®­çª—å£
            ctx.fillStyle = '#87CEEB';
            ctx.beginPath();
            ctx.arc(x, y + 10, 5, 0, Math.PI * 2);
            ctx.fill();
            
            // ç«ç®­ç¿…è†€
            ctx.fillStyle = '#B22222';
            ctx.beginPath();
            ctx.moveTo(x - 10, y + 20);
            ctx.lineTo(x - 18, y + 30);
            ctx.lineTo(x - 10, y + 30);
            ctx.closePath();
            ctx.fill();
            
            ctx.beginPath();
            ctx.moveTo(x + 10, y + 20);
            ctx.lineTo(x + 18, y + 30);
            ctx.lineTo(x + 10, y + 30);
            ctx.closePath();
            ctx.fill();
            
            // ç«èŠ±æ•ˆæœ
            for (let i = 0; i < 3; i++) {
                ctx.fillStyle = ['#FFD700', '#FFA500', '#FF6347'][i];
                ctx.beginPath();
                ctx.arc(x + (Math.random() - 0.5) * 10, y + 45 + Math.random() * 10, Math.random() * 3 + 1, 0, Math.PI * 2);
                ctx.fill();
            }
            
            ctx.restore();
        }
        
        // ==================== ç‰¹æ•ˆç³»ç»Ÿ ====================
        let attackEffects = [];
        let victoryEffects = [];
        
        function createAttackEffect(x, y) {
            for (let i = 0; i < 20; i++) {
                attackEffects.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    life: 30,
                    color: ['#FFD700', '#FF69B4', '#FF1493', '#FFA500'][Math.floor(Math.random() * 4)],
                    size: Math.random() * 5 + 3
                });
            }
        }
        
        function createVictoryEffect() {
            for (let i = 0; i < 50; i++) {
                victoryEffects.push({
                    x: canvas.width / 2,
                    y: canvas.height / 2,
                    vx: (Math.random() - 0.5) * 15,
                    vy: (Math.random() - 0.5) * 15,
                    life: 60,
                    color: ['#FFD700', '#FF69B4', '#FF1493', '#FFA500', '#00FF00'][Math.floor(Math.random() * 5)],
                    size: Math.random() * 8 + 5
                });
            }
        }
        
        function updateEffects() {
            // æ›´æ–°æ”»å‡»ç‰¹æ•ˆ
            for (let i = attackEffects.length - 1; i >= 0; i--) {
                const e = attackEffects[i];
                e.x += e.vx;
                e.y += e.vy;
                e.vy += 0.3;
                e.life--;
                if (e.life <= 0) {
                    attackEffects.splice(i, 1);
                }
            }
            
            // æ›´æ–°èƒœåˆ©ç‰¹æ•ˆ
            for (let i = victoryEffects.length - 1; i >= 0; i--) {
                const e = victoryEffects[i];
                e.x += e.vx;
                e.y += e.vy;
                e.vy += 0.2;
                e.life--;
                if (e.life <= 0) {
                    victoryEffects.splice(i, 1);
                }
            }
        }
        
        function renderEffects() {
            ctx.save();
            
            // æ¸²æŸ“æ”»å‡»ç‰¹æ•ˆ
            attackEffects.forEach(e => {
                ctx.globalAlpha = e.life / 30;
                ctx.fillStyle = e.color;
                ctx.beginPath();
                ctx.arc(e.x, e.y, e.size, 0, Math.PI * 2);
                ctx.fill();
            });
            
            // æ¸²æŸ“èƒœåˆ©ç‰¹æ•ˆ
            victoryEffects.forEach(e => {
                ctx.globalAlpha = e.life / 60;
                ctx.fillStyle = e.color;
                ctx.beginPath();
                ctx.arc(e.x, e.y, e.size, 0, Math.PI * 2);
                ctx.fill();
            });
            
            ctx.restore();
        }
        
        // ==================== æç¤ºç³»ç»Ÿ ====================
        let currentHint = null;
        let hintTimeout = null;
        
        function showHint(text, duration = 2000, forceShow = false) {
            // åªæœ‰å¼ºåˆ¶æ˜¾ç¤ºæ—¶æ‰æ˜¾ç¤ºæç¤º
            if (!forceShow) {
                return;
            }
            
            const hintModal = document.getElementById('hint-modal');
            const hintText = document.getElementById('hint-text');
            
            hintText.textContent = text;
            hintModal.classList.add('active');
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (hintTimeout) {
                clearTimeout(hintTimeout);
            }
            
            // è‡ªåŠ¨å…³é—­
            hintTimeout = setTimeout(() => {
                closeHint();
            }, duration);
        }
        
        function closeHint() {
            const hintModal = document.getElementById('hint-modal');
            hintModal.classList.remove('active');
            if (hintTimeout) {
                clearTimeout(hintTimeout);
                hintTimeout = null;
            }
        }
        
        function updateHint() {
            // ä¸å†éœ€è¦æ›´æ–°ï¼Œæ”¹ç”¨HTMLå¼¹çª—
        }
        
        function renderHint() {
            // æç¤ºæ”¹ä¸ºHTMLå¼¹çª—æ˜¾ç¤ºï¼Œä¸åœ¨canvasä¸Šç»˜åˆ¶
        }

        // ==================== æ¸¸æˆä¸»å¾ªç¯ ====================
        function gameLoop() {
            update();
            updateHint();
            updateEffects();
            render();
            requestAnimationFrame(gameLoop);
        }

        // ==================== å¼€å§‹æ¸¸æˆ ====================
        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            game.state = 'playing';
            game.hearts = 3;
            game.stars = 0;
            game.startTime = Date.now();
            player.weapon = null;
            keyFragments = 0;
            
            // é‡ç½®æ‰€æœ‰å…³å¡çŠ¶æ€
            Object.values(levels).forEach(level => {
                if (level.questionBox) level.questionBox.asked = false;
                if (level.lockedDoor) level.lockedDoor.opened = false;
            });
            
            loadLevel(1);
        }

        function restartGame() {
            document.getElementById('ending-screen').classList.remove('active');
            document.getElementById('start-screen').classList.remove('hidden');
            game.state = 'start';
            game.hearts = 3;
            game.stars = 0;
            player.weapon = null;
            keyFragments = 0;
            
            // é‡ç½®æ‰€æœ‰å…³å¡çš„é—®å·ç®±çŠ¶æ€
            Object.values(levels).forEach(level => {
                if (level.questionBox) level.questionBox.asked = false;
                if (level.lockedDoor) level.lockedDoor.opened = false;
            });
        }

        // åˆå§‹åŒ–æ¸¸æˆå¾ªç¯
        gameLoop();
    </script>
</body>
</html>
